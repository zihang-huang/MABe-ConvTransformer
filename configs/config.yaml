# MABe-2.0 Behavior Recognition Configuration

# Paths
paths:
  data_dir: ./kaggle/input/MABe-mouse-behavior-detection
  train_tracking: ${paths.data_dir}/train_tracking
  train_annotation: ${paths.data_dir}/train_annotation
  test_tracking: ${paths.data_dir}/test_tracking
  train_csv: ${paths.data_dir}/train.csv
  test_csv: ${paths.data_dir}/test.csv
  output_dir: ./outputs
  checkpoint_dir: ${paths.output_dir}/checkpoints

# Data settings
data:
  target_fps: 30
  window_size: 512  # frames per sample
  stride: 256  # sliding window stride
  val_split: 0.2   # fraction of data for validation
  test_split: 0  # fraction of data for held-out test
  enable_test_split: false  # When false, skip creating a held-out test split (train/val only)
  min_segment_duration: 5  # minimum frames for valid segment
  tracking_cache_size: 2
  annotation_cache_size: 4
  use_precomputed: true  # When true, load precomputed shards instead of raw parquet
  precomputed_dir: ${paths.data_dir}/precomputed  # Output location for precompute script

  # Rare behavior oversampling (for class imbalance)
  oversample_rare: true  # Oversample windows containing rare behaviors
  rare_behaviors:  # Behaviors to oversample (test-relevant rare classes)
    - submit       # Only 86 training examples
    - chaseattack  # Only 57 training examples
    - ejaculate
    - intromit
  oversample_factor: 10  # How many times to repeat rare behavior windows

  # Body parts (common across labs)
  core_body_parts:
    - nose
    - neck
    - body_center
    - tail_base

  all_body_parts:
    - ear_left
    - ear_right
    - nose
    - neck
    - body_center
    - lateral_left
    - lateral_right
    - hip_left
    - hip_right
    - tail_base
    - tail_tip

# Behaviors4
behaviors:
  self:
    - biteobject
    - climb
    - dig
    - exploreobject
    - freeze
    - genitalgroom
    - huddle
    - rear
    - rest
    - run
    - selfgroom

  pair:
    - allogroom
    - approach
    - attack
    - attemptmount
    - avoid
    - chase
    - chaseattack
    - defend
    - disengage
    - dominance
    - dominancegroom
    - dominancemount
    - ejaculate
    - escape
    - flinch
    - follow
    - intromit
    - mount
    - reciprocalsniff
    - shepherd
    - sniff
    - sniffbody
    - sniffface
    - sniffgenital
    - submit
    - tussle

# Feature settings
features:
  # Master toggle for engineered features
  use_engineered_features: true  # Enable velocity, acceleration, pairwise, temporal features

  # Feature type toggles
  use_raw_coords: true      # Include raw keypoint coordinates
  use_single_mouse: true    # Include single mouse features (velocity, acceleration, etc.)
  use_pairwise: true        # Include pairwise interaction features
  use_temporal: true        # Include temporal rolling statistics

  # Temporal windows for rolling statistics
  temporal_windows: [5, 15, 30, 60]  # frames

  # Single mouse features
  single_mouse:
    position: true
    velocity: true
    acceleration: true
    orientation: true
    body_shape: true

  # Pair features
  pair:
    relative_position: true
    relative_velocity: true
    distance: true
    facing_angle: true

# Model settings
model:
  name: mstcn  # Options: mstcn, tcn_transformer

  # Input/Output
  input_dim: null  # Computed from features
  num_classes: null  # Computed from behaviors

  # MS-TCN++ architecture
  mstcn:
    num_stages: 4
    num_layers: 10
    num_f_maps: 64
    kernel_size: 3
    dropout: 0.5

  # TCN + Transformer hybrid
  tcn_transformer:
    tcn_channels: [64, 128, 256]
    tcn_kernel_size: 3
    transformer_heads: 8
    transformer_layers: 2
    transformer_dim: 256
    dropout: 0.3

# Training settings
training:
  batch_size: 256
  num_workers: 8
  max_epochs: 1000
  learning_rate: 0.001  # Scaled roughly linearly for 32x larger batch
  weight_decay: 0.0003  # Extra regularization to offset low gradient noise at large batch
  prefetch_factor: 8

  # Learning rate scheduler
  scheduler:
    name: cosine
    warmup_epochs: 30  # More warmup epochs to match similar warmup steps with fewer steps/epoch
    min_lr: 0.00032

  # Loss weights
  loss:
    classification_weight: 1.0
    smoothness_weight: 0.15
    boundary_weight: 0.0

  # Class imbalance handling
  # Use 'none' with focal loss instead - more stable than pos_weight for extreme imbalance
  class_weighting: pos_neg_ratio  # Options: inverse, effective_num, pos_neg_ratio, none
  effective_num_beta: 0.9999
  use_focal_loss: true  # Use focal loss to handle class imbalance without pos_weight
  focal_gamma: 1.5  # Focus on hard examples

  # Early stopping
  early_stopping:
    patience: 150  # More epochs to allow comparable update count with larger batches
    monitor: val_segment_f1
    mode: max

# Domain adaptation
domain_adaptation:
  enabled: false
  method: batch_norm  # Options: adversarial, batch_norm, none
  lab_specific_bn: true

# Evaluation
evaluation:
  threshold: 0.30
  min_duration: 5
  smoothing_kernel: 5
  nms_threshold: 0.3
  merge_gap: 5
  segment_eval: true  # Use Kaggle-compatible segment-level F1 for training

# Experiment tracking
logging:
  project: mabe-behavior
  run_name: null
  use_wandb: false
